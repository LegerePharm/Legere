<odoo>
  <data>
    <record id="view_picking_type_form" model="ir.ui.view">
        <field name="name">Operation Types</field>
        <field name="model">stock.picking.type</field>
        <field name="inherit_id" ref="stock.view_picking_type_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='show_reserved']" position="after">
                <field name="required_carrier"/>
            </xpath>
        </field>
    </record>

    <record id="view_picking_form_inherit" model="ir.ui.view">
        <field name="name">Stock Picking Inherit</field>
        <field name="model">stock.picking</field>
        <field name="inherit_id" ref="stock.view_picking_form"/>
        <field name="arch" type="xml">
            <!-- Move Picking_type_id to the other side of the form view-->
            <xpath expr="//field[@name='picking_type_id']" position="replace">
            </xpath>
            <field name="origin" position="after">
                <field name="picking_type_id" />
            </field>
            <!-- Add EasyPost views-->
            <field name="partner_id" position="attributes">
                <attribute name="widget">res_partner_many2one</attribute>
                <attribute name="context">{'show_address': 1}</attribute>
                <attribute name="options">{'always_reload': True}</attribute>
            </field>
            <field name="partner_id" position="after">
                <field name="customer_contact_no" attrs="{'invisible': [('picking_type_code', '!=' ,'outgoing')]}"/>
                <field name="is_easypost_delivery" invisible="1"/>
                <field name="is_tracking_available" invisible="1"/>
            </field>
            <header position="inside">
                <button name="send_easypost_confirmation_email" string="Send Tracking Email" type="object" class="oe_highlight"
                        attrs="{'invisible': ['|',('is_easypost_delivery', '=', False),('ep_shipment_ids','=',[])]}"/>
                <button name="action_download_label" string="Download Label" type="object" class="oe_highlight" attrs="{'invisible': [('ep_shipment_ids','=',[])]}"/>
            </header>
            <xpath expr="//notebook//page[1]" position="before">
                <page string="Tracking Information" attrs="{'invisible': ['|', ('is_easypost_delivery', '=', False), ('is_tracking_available', '=', False)]}">
                    <div style="margin-top:10px;margin-bottom:10px;">
                        <button name="update_tracking_button" string="Update Tracking Info" type="object" class="oe_highlight"
                            attrs="{'invisible': ['|',('is_easypost_delivery', '=', False),('ep_shipment_ids','=',[])]}"/>
                        <button name="cancel_shipment" string="Cancel Shipping Label" type="object" class="oe_highlight"
                                attrs="{'invisible': ['|',('is_easypost_delivery', '=', False),('ep_shipment_ids','=',[])]}" style="margin-left:10px;"/>
                        <button name="create_missing_tracking_details" string="Retrieve Tracking Details" type="object" class="oe_highlight"
                                attrs="{'invisible': ['|','|',('is_easypost_delivery', '=', False),('ep_shipment_ids','!=',[]),('ep_order_id', '=', False)]}" style="margin-left:10px;"/> 
                    </div>
                    <field name="ep_shipment_ids" readonly="1">
                        <tree>
                            <field name="name" />
                            <field name="is_return_shipment"/>
                            <field name="package_id" />
                            <field name="submit_elec" string="Customs Submitted"/>
                            <field name="est_delivery_date"/>
                            <field name="tracking_status" />
                            <button name="open_website_url" class="oe_highlight" type="object" string="Tracking"/>
                            <button name="action_view_tracking_history" string="History" type="object" class="oe_highlight"/>
                        </tree>
                        <form>
                            <group>
                                <group>
                                    <field name="name" readonly="1"/>
                                    <field name="is_return_shipment"/>
                                    <field name="shipping_id" readonly="1"/>
                                    <field name="est_delivery_date"/>
                                    <field name="scan_form_status" readonly="1"/>
                                    <field name="tracking_status" readonly="1"/>
                                    <field name="tracking_url" widget="url" readonly="1"/>
                                    <field name="package_id" readonly="1"/>
                                    <field name="submit_elec" readonly="1"/>
                                    <field name="customs_form_url" widget="url" readonly="1"/>
                                </group>
                                <group>
                                    <field name="refund_status" />
                                </group>
                            </group>
                        </form>
                    </field>
                </page>
            </xpath>
            <field name="carrier_id" position="attributes">
                <attribute name="context">{'is_easypost': True}</attribute>
            </field>
            <field name="delivery_type" position="after">
                <field name="carrier_price" readonly="1" attrs="{'invisible': [('state','=','draft')]}" groups="base.group_no_one"/>
                <field name="ep_order_id" readonly="1" attrs="{'invisible': [('delivery_type', '!=', 'easypost')]}"/>
                <field name="shipping_id"  readonly="1" attrs="{'invisible': [('delivery_type', '!=', 'easypost')]}" groups="base.group_no_one"/>
            </field>
            <button name="send_to_shipper" position="attributes">
                <attribute name="attrs">{'invisible':['|','|','|','|',('carrier_tracking_ref','!=',False),
                    ('delivery_type','in', ['fixed', 'base_on_rule']),('delivery_type','=',False),
                    ('is_easypost_delivery', '!=', False),('state', '!=','done')]}</attribute>
            </button>
        </field>
    </record>

    <record id="stock_picking_carrier_position" model="ir.ui.view">
        <field name='name'>stock.picking.form.carrier.position</field>
        <field name='model'>stock.picking</field>
        <field name="inherit_id" ref="delivery.view_picking_withcarrier_out_form"/>
        <field name='arch' type='xml'>
            <xpath expr="//field[@name='carrier_id']" position="replace">
            </xpath>
            <xpath expr="//field[@name='partner_id']" position="after">
                <label for="carrier_id" string="Carrier"/>
                <div>
                    <field name="carrier_id" attrs="{'readonly':['|',('has_tracking','=',True),('is_easypost_delivery','=',True)], 'required': [('required_carrier', '!=', False)]}"/>
                    <button style="margin-left:10px;" string="Get Rate" type="object" name="get_easypost_rate" class="btn btn-primary" attrs="{'invisible':[('delivery_type','!=','easypost')]}"/>
                </div>
                <field name="cash_on_delivery" attrs="{'invisible': [('delivery_type', '!=', 'easypost')], 'readonly':[('state','=','done')]}" />
                <field name="cod_method" attrs="{'invisible': [('cash_on_delivery', '=', False)], 'readonly':[('state','=','done')]}"/>
                <field name="cod_amount" attrs="{'invisible': [('cash_on_delivery', '=', False)], 'readonly':[('state','=','done')]}"/>
                <field name="add_insurance" attrs="{'invisible': [('delivery_type', '!=', 'easypost')], 'readonly':[('state','=','done')]}" />
                <field name="add_sat_delivery" attrs="{'invisible': [('delivery_type', '!=', 'easypost')], 'readonly':[('state','=','done')]}" />
                <field name="add_signature" attrs="{'invisible': [('delivery_type', '!=', 'easypost')], 'readonly':[('state','=','done')]}" />
                <field name="create_return_label" attrs="{'invisible': [('delivery_type', '!=', 'easypost')], 'readonly':[('state','=','done')]}" />
                <field name="incoterm_id" attrs="{'invisible': [('delivery_type', '!=', 'easypost')], 'readonly':[('state','=','done')]}"/>
                <field name="packaging_id" attrs="{'invisible': [('delivery_type', '!=', 'easypost')], 'readonly':[('state','=','done')]}"/>
                <field name="eel_pfc" attrs="{'invisible': [('ship_international', '=', False)],'required': [('delivery_type', '=', 'easypost')]}"/>
                <field name="ship_international" invisible="1"/>
                <field name="required_carrier" invisible="1"/>
            </xpath>
        </field>
    </record>
  </data>
</odoo>